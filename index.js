(()=>{"use strict";var e={387:(e,n,t)=>{e.exports=t.p+"584412a3ae5720fc3fdc.wasm"}},n={};function t(r){var a=n[r];if(void 0!==a)return a.exports;var o=n[r]={exports:{}};return e[r](o,o.exports,t),o.exports}t.m=e,t.u=e=>e+".index.js",t.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),t.o=(e,n)=>Object.prototype.hasOwnProperty.call(e,n),(()=>{var e;t.g.importScripts&&(e=t.g.location+"");var n=t.g.document;if(!e&&n&&(n.currentScript&&(e=n.currentScript.src),!e)){var r=n.getElementsByTagName("script");r.length&&(e=r[r.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),t.p=e})(),t.b=document.baseURI||self.location.href,(()=>{const e=Symbol("Comlink.proxy"),n=Symbol("Comlink.endpoint"),r=Symbol("Comlink.releaseProxy"),a=Symbol("Comlink.thrown"),o=e=>"object"==typeof e&&null!==e||"function"==typeof e,i=new Map([["proxy",{canHandle:n=>o(n)&&n[e],serialize(e){const{port1:n,port2:t}=new MessageChannel;return c(e,n),[t,[t]]},deserialize:e=>(e.start(),s(e))}],["throw",{canHandle:e=>o(e)&&a in e,serialize({value:e}){let n;return n=e instanceof Error?{isError:!0,value:{message:e.message,name:e.name,stack:e.stack}}:{isError:!1,value:e},[n,[]]},deserialize(e){if(e.isError)throw Object.assign(new Error(e.value.message),e.value);throw e.value}}]]);function c(e,n=self){n.addEventListener("message",(function t(r){if(!r||!r.data)return;const{id:o,type:i,path:s}=Object.assign({path:[]},r.data),_=(r.data.argumentList||[]).map(m);let f;try{const n=s.slice(0,-1).reduce(((e,n)=>e[n]),e),t=s.reduce(((e,n)=>e[n]),e);switch(i){case"GET":f=t;break;case"SET":n[s.slice(-1)[0]]=m(r.data.value),f=!0;break;case"APPLY":f=t.apply(n,_);break;case"CONSTRUCT":f=w(new t(..._));break;case"ENDPOINT":{const{port1:n,port2:t}=new MessageChannel;c(e,t),f=g(n,[n])}break;case"RELEASE":f=void 0;break;default:return}}catch(e){f={value:e,[a]:0}}Promise.resolve(f).catch((e=>({value:e,[a]:0}))).then((e=>{const[r,a]=d(e);n.postMessage(Object.assign(Object.assign({},r),{id:o}),a),"RELEASE"===i&&(n.removeEventListener("message",t),u(n))}))})),n.start&&n.start()}function u(e){(function(e){return"MessagePort"===e.constructor.name})(e)&&e.close()}function s(e,n){return f(e,[],n)}function _(e){if(e)throw new Error("Proxy has been released and is not useable")}function f(e,t=[],a=function(){}){let o=!1;const i=new Proxy(a,{get(n,a){if(_(o),a===r)return()=>p(e,{type:"RELEASE",path:t.map((e=>e.toString()))}).then((()=>{u(e),o=!0}));if("then"===a){if(0===t.length)return{then:()=>i};const n=p(e,{type:"GET",path:t.map((e=>e.toString()))}).then(m);return n.then.bind(n)}return f(e,[...t,a])},set(n,r,a){_(o);const[i,c]=d(a);return p(e,{type:"SET",path:[...t,r].map((e=>e.toString())),value:i},c).then(m)},apply(r,a,i){_(o);const c=t[t.length-1];if(c===n)return p(e,{type:"ENDPOINT"}).then(m);if("bind"===c)return f(e,t.slice(0,-1));const[u,s]=l(i);return p(e,{type:"APPLY",path:t.map((e=>e.toString())),argumentList:u},s).then(m)},construct(n,r){_(o);const[a,i]=l(r);return p(e,{type:"CONSTRUCT",path:t.map((e=>e.toString())),argumentList:a},i).then(m)}});return i}function l(e){const n=e.map(d);return[n.map((e=>e[0])),(t=n.map((e=>e[1])),Array.prototype.concat.apply([],t))];var t}const b=new WeakMap;function g(e,n){return b.set(e,n),e}function w(n){return Object.assign(n,{[e]:!0})}function d(e){for(const[n,t]of i)if(t.canHandle(e)){const[r,a]=t.serialize(e);return[{type:"HANDLER",name:n,value:r},a]}return[{type:"RAW",value:e},b.get(e)||[]]}function m(e){switch(e.type){case"HANDLER":return i.get(e.name).deserialize(e.value);case"RAW":return e.value}}function p(e,n,t){return new Promise((r=>{const a=new Array(4).fill(0).map((()=>Math.floor(Math.random()*Number.MAX_SAFE_INTEGER).toString(16))).join("-");e.addEventListener("message",(function n(t){t.data&&t.data.id&&t.data.id===a&&(e.removeEventListener("message",n),r(t.data))})),e.start&&e.start(),e.postMessage(Object.assign({id:a},n),t)}))}const h=navigator.hardwareConcurrency||8,y=[];function v(e){return 256*e}async function E({sceneNum:e,width:n,height:t,numSamples:r,maxDepth:a,enableBvh:o}){const i=performance.now();var c=await async function(e,n,t,r,a,o){var i=[],c=0,u=r,s=0;do{c<h?(i.push(0),c++,s=i.length-1):s=(s+1)%h,i[s]++,u--}while(u>0);for(var _=[],f=0;f<i.length;f++)_.push(y[f].workerRenderImage(e,n,t,i[f],a,o));var l=[];for(f=0;f<_.length;f++)l.push(await _[f]);for(var b,g=n*t*4,w=new Uint8ClampedArray(g),d=1/r,m=0,p=0;p<g;p++)if(0!=(m=(m+1)%4)){for(var E=0,I=0;I<l.length;I++)E+=l[I][p];w[p]=v((b=E*d,Math.max(0,Math.min(Math.sqrt(b),.999))))}else w[p]=255;return w}(e,n,t,r,a,o);const u=performance.now()-i;return{rawImageData:g(c,[c.buffer]),time:u}}let I;const S=new Array(32).fill(void 0);function k(e){return S[e]}S.push(void 0,null,!0,!1);let x=S.length;function A(e){const n=k(e);return function(e){e<36||(S[e]=x,x=e)}(e),n}let R=0,T=null;function j(){return null!==T&&T.buffer===I.memory.buffer||(T=new Uint8Array(I.memory.buffer)),T}let O=new TextEncoder("utf-8");const B="function"==typeof O.encodeInto?function(e,n){return O.encodeInto(e,n)}:function(e,n){const t=O.encode(e);return n.set(t),{read:e.length,written:t.length}};function W(e,n,t){if(void 0===t){const t=O.encode(e),r=n(t.length);return j().subarray(r,r+t.length).set(t),R=t.length,r}let r=e.length,a=n(r);const o=j();let i=0;for(;i<r;i++){const n=e.charCodeAt(i);if(n>127)break;o[a+i]=n}if(i!==r){0!==i&&(e=e.slice(i)),a=t(a,r,r=i+3*e.length);const n=j().subarray(a+i,a+r);i+=B(e,n).written}return R=i,a}let L=null;function M(){return null!==L&&L.buffer===I.memory.buffer||(L=new Int32Array(I.memory.buffer)),L}let N=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});function P(e,n){return N.decode(j().subarray(e,e+n))}function C(e){x===S.length&&S.push(S.length+1);const n=x;return x=S[n],S[n]=e,n}function D(e){return null==e}function $(e){const n=typeof e;if("number"==n||"boolean"==n||null==e)return`${e}`;if("string"==n)return`"${e}"`;if("symbol"==n){const n=e.description;return null==n?"Symbol":`Symbol(${n})`}if("function"==n){const n=e.name;return"string"==typeof n&&n.length>0?`Function(${n})`:"Function"}if(Array.isArray(e)){const n=e.length;let t="[";n>0&&(t+=$(e[0]));for(let r=1;r<n;r++)t+=", "+$(e[r]);return t+="]",t}const t=/\[object ([^\]]+)\]/.exec(toString.call(e));let r;if(!(t.length>1))return toString.call(e);if(r=t[1],"Object"==r)try{return"Object("+JSON.stringify(e)+")"}catch(e){return"Object"}return e instanceof Error?`${e.name}: ${e.message}\n${e.stack}`:r}function U(e,n,t){I._dyn_core__ops__function__FnMut__A____Output___R_as_wasm_bindgen__closure__WasmClosure___describe__invoke__hf99feacbd5825bd2(e,n,C(t))}function F(e,n){try{const u=I.__wbindgen_add_to_stack_pointer(-16);!function(e,n){if(!(e instanceof n))throw new Error(`expected instance of ${n.name}`);e.ptr}(e,H);var t=W(n,I.__wbindgen_malloc,I.__wbindgen_realloc),r=R;I.get_resource(u,e.ptr,t,r);var a=M()[u/4+0],o=M()[u/4+1];let s;return 0!==a&&(s=(i=a,c=o,j().subarray(i/1,i/1+c)).slice(),I.__wbindgen_free(a,1*o)),s}finally{I.__wbindgen_add_to_stack_pointer(16)}var i,c}function z(e,n){try{return e.apply(this,n)}catch(e){I.__wbindgen_exn_store(C(e))}}N.decode();class H{static __wrap(e){const n=Object.create(H.prototype);return n.ptr=e,n}__destroy_into_raw(){const e=this.ptr;return this.ptr=0,e}free(){const e=this.__destroy_into_raw();I.__wbg_resourcecache_free(e)}}const q=async function e(n){void 0===n&&(n=new URL(t(387),t.b));const r={wbg:{}};r.wbg.__wbindgen_object_drop_ref=function(e){A(e)},r.wbg.__wbindgen_json_serialize=function(e,n){const t=k(n);var r=W(JSON.stringify(void 0===t?null:t),I.__wbindgen_malloc,I.__wbindgen_realloc),a=R;M()[e/4+1]=a,M()[e/4+0]=r},r.wbg.__wbg_resourcecache_new=function(e){return C(H.__wrap(e))},r.wbg.__wbindgen_string_new=function(e,n){return C(P(e,n))},r.wbg.__wbindgen_cb_drop=function(e){const n=A(e).original;return 1==n.cnt--&&(n.a=0,!0)},r.wbg.__wbg_new_693216e109162396=function(){return C(new Error)},r.wbg.__wbg_stack_0ddaca5d1abfb52f=function(e,n){var t=W(k(n).stack,I.__wbindgen_malloc,I.__wbindgen_realloc),r=R;M()[e/4+1]=r,M()[e/4+0]=t},r.wbg.__wbg_error_09919627ac0992f5=function(e,n){try{console.error(P(e,n))}finally{I.__wbindgen_free(e,n)}},r.wbg.__wbindgen_object_clone_ref=function(e){return C(k(e))},r.wbg.__wbg_fetch_45791be0f20b9c8d=function(e){return C(fetch(k(e)))},r.wbg.__wbg_instanceof_Window_c4b70662a0d2c5ec=function(e){return k(e)instanceof Window},r.wbg.__wbg_document_1c64944725c0d81d=function(e){var n=k(e).document;return D(n)?0:C(n)},r.wbg.__wbg_URL_db6637e306672144=function(){return z((function(e,n){var t=W(k(n).URL,I.__wbindgen_malloc,I.__wbindgen_realloc),r=R;M()[e/4+1]=r,M()[e/4+0]=t}),arguments)},r.wbg.__wbg_new_9c35e8e8b09fb4a3=function(){return z((function(){return C(new Headers)}),arguments)},r.wbg.__wbg_append_fb85316567f7a798=function(){return z((function(e,n,t,r,a){k(e).append(P(n,t),P(r,a))}),arguments)},r.wbg.__wbindgen_string_get=function(e,n){const t=k(n);var r="string"==typeof t?t:void 0,a=D(r)?0:W(r,I.__wbindgen_malloc,I.__wbindgen_realloc),o=R;M()[e/4+1]=o,M()[e/4+0]=a},r.wbg.__wbg_log_3445347661d4505e=function(e){console.log(k(e))},r.wbg.__wbg_fetch_b4e81012e07ff95a=function(e,n){return C(k(e).fetch(k(n)))},r.wbg.__wbg_instanceof_Response_e1b11afbefa5b563=function(e){return k(e)instanceof Response},r.wbg.__wbg_url_50e0bdb6051741be=function(e,n){var t=W(k(n).url,I.__wbindgen_malloc,I.__wbindgen_realloc),r=R;M()[e/4+1]=r,M()[e/4+0]=t},r.wbg.__wbg_status_6d8bb444ddc5a7b2=function(e){return k(e).status},r.wbg.__wbg_headers_5ffa990806e04cfc=function(e){return C(k(e).headers)},r.wbg.__wbg_arrayBuffer_b8937ed04beb0d36=function(){return z((function(e){return C(k(e).arrayBuffer())}),arguments)},r.wbg.__wbg_newwithstrandinit_9b0fa00478c37287=function(){return z((function(e,n,t){return C(new Request(P(e,n),k(t)))}),arguments)},r.wbg.__wbindgen_is_function=function(e){return"function"==typeof k(e)},r.wbg.__wbg_newnoargs_be86524d73f67598=function(e,n){return C(new Function(P(e,n)))},r.wbg.__wbindgen_is_object=function(e){const n=k(e);return"object"==typeof n&&null!==n},r.wbg.__wbg_next_c4151d46d5fa7097=function(e){return C(k(e).next)},r.wbg.__wbg_next_7720502039b96d00=function(){return z((function(e){return C(k(e).next())}),arguments)},r.wbg.__wbg_done_b06cf0578e89ff68=function(e){return k(e).done},r.wbg.__wbg_value_e74a542443d92451=function(e){return C(k(e).value)},r.wbg.__wbg_iterator_4fc4ce93e6b92958=function(){return C(Symbol.iterator)},r.wbg.__wbg_get_4d0f21c2f823742e=function(){return z((function(e,n){return C(Reflect.get(k(e),k(n)))}),arguments)},r.wbg.__wbg_call_888d259a5fefc347=function(){return z((function(e,n){return C(k(e).call(k(n)))}),arguments)},r.wbg.__wbg_new_0b83d3df67ecb33e=function(){return C(new Object)},r.wbg.__wbg_call_346669c262382ad7=function(){return z((function(e,n,t){return C(k(e).call(k(n),k(t)))}),arguments)},r.wbg.__wbg_new_b1d61b5687f5e73a=function(e,n){try{var t={a:e,b:n},r=new Promise(((e,n)=>{const r=t.a;t.a=0;try{return function(e,n,t,r){I.wasm_bindgen__convert__closures__invoke2_mut__h48f663e5394f411e(e,n,C(t),C(r))}(r,t.b,e,n)}finally{t.a=r}}));return C(r)}finally{t.a=t.b=0}},r.wbg.__wbg_resolve_d23068002f584f22=function(e){return C(Promise.resolve(k(e)))},r.wbg.__wbg_then_2fcac196782070cc=function(e,n){return C(k(e).then(k(n)))},r.wbg.__wbg_then_8c2d62e8ae5978f7=function(e,n,t){return C(k(e).then(k(n),k(t)))},r.wbg.__wbg_self_c6fbdfc2918d5e58=function(){return z((function(){return C(self.self)}),arguments)},r.wbg.__wbg_window_baec038b5ab35c54=function(){return z((function(){return C(window.window)}),arguments)},r.wbg.__wbg_globalThis_3f735a5746d41fbd=function(){return z((function(){return C(globalThis.globalThis)}),arguments)},r.wbg.__wbg_global_1bc0b39582740e95=function(){return z((function(){return C(t.g.global)}),arguments)},r.wbg.__wbindgen_is_undefined=function(e){return void 0===k(e)},r.wbg.__wbg_buffer_397eaa4d72ee94dd=function(e){return C(k(e).buffer)},r.wbg.__wbg_newwithbyteoffsetandlength_4b9b8c4e3f5adbff=function(e,n,t){return C(new Uint8Array(k(e),n>>>0,t>>>0))},r.wbg.__wbg_new_a7ce447f15ff496f=function(e){return C(new Uint8Array(k(e)))},r.wbg.__wbg_set_969ad0a60e51d320=function(e,n,t){k(e).set(k(n),t>>>0)},r.wbg.__wbg_length_1eb8fc608a0d4cdb=function(e){return k(e).length},r.wbg.__wbg_has_1275b5eec3dc7a7a=function(){return z((function(e,n){return Reflect.has(k(e),k(n))}),arguments)},r.wbg.__wbg_set_82a4e8a85e31ac42=function(){return z((function(e,n,t){return Reflect.set(k(e),k(n),k(t))}),arguments)},r.wbg.__wbg_stringify_d4507a59932eed0c=function(){return z((function(e){return C(JSON.stringify(k(e)))}),arguments)},r.wbg.__wbindgen_debug_string=function(e,n){var t=W($(k(n)),I.__wbindgen_malloc,I.__wbindgen_realloc),r=R;M()[e/4+1]=r,M()[e/4+0]=t},r.wbg.__wbindgen_throw=function(e,n){throw new Error(P(e,n))},r.wbg.__wbindgen_memory=function(){return C(I.memory)},r.wbg.__wbindgen_closure_wrapper300=function(e,n,t){var r=function(e,n,t,r){const a={a:e,b:n,cnt:1,dtor:122},o=(...e)=>{a.cnt++;const n=a.a;a.a=0;try{return r(n,a.b,...e)}finally{0==--a.cnt?I.__wbindgen_export_2.get(a.dtor)(n,a.b):a.a=n}};return o.original=a,o}(e,n,0,U);return C(r)},("string"==typeof n||"function"==typeof Request&&n instanceof Request||"function"==typeof URL&&n instanceof URL)&&(n=fetch(n));const{instance:a,module:o}=await async function(e,n){if("function"==typeof Response&&e instanceof Response){if("function"==typeof WebAssembly.instantiateStreaming)try{return await WebAssembly.instantiateStreaming(e,n)}catch(n){if("application/wasm"==e.headers.get("Content-Type"))throw n;console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",n)}const t=await e.arrayBuffer();return await WebAssembly.instantiate(t,n)}{const t=await WebAssembly.instantiate(e,n);return t instanceof WebAssembly.Instance?{instance:t,module:e}:t}}(await n,r);return I=a.exports,e.__wbindgen_wasm_module=o,I.__wbindgen_start(),I},G=document.getElementById("canvas"),{width:J,height:Y}=G,X=G.getContext("2d"),K=document.getElementById("time"),Q=document.getElementById("numThreads"),V=new Map,Z=document.getElementById("sceneNum"),ee=document.getElementById("samplesNum"),ne=document.getElementById("maxDepthNum"),te=document.getElementById("bvhEnable"),re=document.getElementById("resolution");var ae;function oe(e){var n=e/1e3;K.value=`${n.toFixed(2)} sec(s)`}function ie(e,n){var t=document.getElementById(e);Object.assign(t,{async onclick(){se(!1);const e=parseInt(Z.value),t=parseInt(ee.value),r=parseInt(ne.value),a="true"===te.value;let{rawImageData:o,time:i}=await n.renderImage({sceneNum:e,width:J,height:Y,numSamples:t,maxDepth:r,enableBvh:a});oe(i),X.putImageData(new ImageData(o,J,Y),0,0),se(!0)}})}function ce(e,n,t){for(var r=4*(n*J+e),a=0;a<3;a++)ae.data[r+a]=t>>8*(3-a)&255;ae.data[r+3]=255}function ue(){X.putImageData(ae,0,0)}function se(e){for(let[t,r]of V){var n=r&&e;document.getElementById(t).disabled=!n}}!async function(){const e=[{path:"earthmap.jpeg"}];await q();const n=await(r=e,A(I.create_and_load_resource_cache(C(r))));var r;const a=new Map;for(var o=0;o<e.length;o++){var i=e[o].path;a.set(i,F(n,i))}let c=await s(new Worker(new URL(t.p+t.u(135),t.b),{type:void 0})).initHandlers(a);await async function(e){for(var n=0;n<h;n++){let r=await s(new Worker(new URL(t.p+t.u(963),t.b),{type:void 0}));await r.init(n,e),y.push(r)}}(a),Q.value=`${h}`;const u=!!await c.supportsThreads;var _;V.set("singleThreadBtn",!0),V.set("multiThreadBtn",u),V.set("manualWebWorkers",!0),V.set("manualWebWorkersPreview",!0),ie("singleThreadBtn",c.singleThread),ie("multiThreadBtn",c.multiThread),ie("manualWebWorkers",{renderImage:E}),_=document.getElementById("manualWebWorkersPreview"),Object.assign(_,{async onclick(){se(!1),ae=new ImageData(J,Y);const e=setInterval(ue,250),n=parseInt(Z.value),t=parseInt(ee.value),r=parseInt(ne.value),a="true"===te.value;let{time:o}=await async function({sceneNum:e,previewCb:n,width:t,height:r,numSamples:a,maxDepth:o,enableBvh:i}){const c=performance.now();return await async function(e,n,t,r,a,o,i){const c=Math.ceil(t/h),u=[];for(var s=0,_=0;_<t;_+=c){var f=Math.min(c,t-_),l=r;u.push(y[s++].workerRenderImageProgressive(e,w(n),t,r,a,o,i,_,0,f,l))}for(var b=0;b<u.length;b++)await u[b]}(e,n,t,r,a,o,i),{time:performance.now()-c}}({sceneNum:n,previewCb:ce,width:J,height:Y,numSamples:t,maxDepth:r,enableBvh:a});oe(o),clearInterval(e),X.putImageData(ae,0,0),se(!0)}}),se(!0),re.value=`${J}x${Y}`}()})()})();